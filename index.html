<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VayuSetu Portal</title>
    <link rel="icon" type="image/jpeg" href="./favicon.jpg">
    <style>
        :root {
            --primary: #c41e3a; --secondary: #1a237e;
            --glass: rgba(255, 255, 255, 0.94);
            --shadow: 0 15px 40px rgba(0,0,0,0.6);
        }
        body {
            margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif;
            min-height: 100vh; background: url('./BG.jpg') no-repeat center center fixed;
            background-size: cover; display: flex; justify-content: center; align-items: center;
        }
        body::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.25); z-index: -1;
        }
        .container {
            width: 100%; max-width: 460px; background: var(--glass); padding: 40px 35px;
            border-radius: 16px; box-shadow: var(--shadow); border-top: 6px solid var(--primary);
            backdrop-filter: blur(8px); animation: slideUp 0.6s ease-out; text-align: center;
        }
        @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .marquee-container {
            position: fixed; top: 0; left: 0; width: 100%; background: linear-gradient(90deg, var(--primary), #d32f2f); 
            color: white; padding: 10px 0; overflow: hidden; white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 999; font-family: 'Courier New', monospace;
        }
        .marquee-text { display: inline-block; padding-left: 100%; animation: scroll 25s linear infinite; font-weight: bold; font-size: 14px; letter-spacing: 1px; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        .logo-container { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; }
        .logo-container img { height: 75px; width: auto; object-fit: contain; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.15)); }
        h1 { 
            color: var(--primary); margin: 5px 0 0 0; font-size: 34px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1); background: -webkit-linear-gradient(#c41e3a, #ff5252);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .portal-name { 
            font-size: 13px; font-weight: 800; color: var(--secondary); margin-bottom: 25px; 
            text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid #ddd; padding-bottom: 15px;
        }

        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #f1f3f4; padding: 5px; border-radius: 10px; }
        .tab-button {
            flex: 1; padding: 10px; border: none; background: transparent; font-weight: 700; cursor: pointer; color: #666;
            transition: 0.3s; border-radius: 8px; font-size: 13px; text-transform: uppercase;
        }
        .tab-button.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        input, select, textarea {
            width: 100%; padding: 14px; margin-top: 12px; border: 2px solid #e0e0e0; border-radius: 8px;
            box-sizing: border-box; font-size: 14px; background: #fff; transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; }
        input[readonly] { background-color: #f0f0f0; color: #444; border: 2px dashed #ccc; font-weight: bold; text-align: center; letter-spacing: 1px; cursor: not-allowed; }

        .event-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .event-card { 
            background: #fff; border: 2px solid #eee; padding: 12px; border-radius: 8px; cursor: pointer; 
            font-size: 13px; font-weight: bold; transition: all 0.2s; color: #444;
            display: flex; align-items: center; justify-content: center; text-align: center; min-height: 50px;
        }
        .event-card:hover { border-color: var(--secondary); transform: translateY(-2px); }
        .event-card.selected { 
            background: var(--secondary); color: white; border-color: var(--secondary); 
            background-image: linear-gradient(135deg, var(--secondary), #3949ab);
        }
        
        .extra-details-container {
            display: none; margin-top: 15px; padding: 15px; border: 2px solid var(--secondary);
            border-radius: 8px; background: #e8eaf6; text-align: left; animation: fadeIn 0.3s;
        }
        .extra-label { font-size: 12px; font-weight: bold; color: var(--secondary); }

        .btn-submit {
            width: 100%; padding: 16px; margin-top: 25px; background: linear-gradient(135deg, var(--primary), #b71c1c); 
            color: white; border: none; border-radius: 8px; font-weight: 800; font-size: 16px; letter-spacing: 1px;
            cursor: pointer; box-shadow: 0 8px 20px rgba(196, 30, 58, 0.25); transition: transform 0.2s;
        }
        .btn-submit:hover { transform: translateY(-2px); }

        .admin-panel { display: none; margin-top: 25px; padding: 20px; background: #263238; color: white; border-radius: 10px; text-align: left; border: 1px solid #444; }
        .admin-section { margin-bottom: 15px; border-bottom: 1px solid #455a64; padding-bottom: 15px; }
        .btn-admin { width: auto; padding: 8px 15px; background: #546e7a; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; font-size: 12px; font-weight: bold; }
        .btn-danger { background: #d32f2f; }
        
        .footer { margin-top: 30px; font-size: 11px; color: #777; cursor: pointer; user-select: none; font-weight: 500; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .success-icon { font-size: 50px; color: #2e7d32; margin-bottom: 15px; display: block; }
    </style>
</head>
<body>

    <div class="marquee-container"><div class="marquee-text" id="marqueeText">Loading...</div></div>

    <div class="container">
        <div class="logo-container">
            <img src="./ncc-logo-png_seeklogo-440419.png" alt="NCC">
            <img src="./1das.jpg" alt="Unit">
        </div>
        <h1>VAYUSETU</h1>
        <div class="portal-name">1DAS Events Registration</div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('attendance')">Attendance</button>
            <button class="tab-button" onclick="switchTab('event')">Events</button>
        </div>

        <div id="attendance" class="tab-content active">
            <label style="font-size:12px; color:#666; font-weight:bold; display:block; text-align:left; margin-bottom:-8px;">Attendance Date:</label>
            <input type="text" id="displayDate" readonly value="Loading...">
            <input list="regList" id="regAtt" placeholder="Regimental No" required>
            <input list="rankList" id="rankAtt" placeholder="Rank" required>
            <input list="nameList" id="nameAtt" placeholder="Name" required>
            <select id="yearAtt"><option value="">Select Year</option><option>2nd Year</option><option>3rd Year</option></select>
            <select id="squadAtt"><option value="">Select Squadron</option><option>Aquino</option><option>Brar</option><option>Chitnis</option><option>Katre</option></select>
            <button class="btn-submit" onclick="submitData('attendance')">MARK PRESENT</button>
        </div>

        <div id="event" class="tab-content">
            <input list="regList" id="regEvt" placeholder="Regimental No">
            <input list="rankList" id="rankEvt" placeholder="Rank">
            <input list="nameList" id="nameEvt" placeholder="Name">
            <select id="yearEvt"><option value="">Select Year</option><option>2nd Year</option><option>3rd Year</option></select>
            <select id="squadEvt"><option value="">Select Squadron</option><option>Aquino</option><option>Brar</option><option>Chitnis</option><option>Katre</option></select>

            <p style="text-align:left; font-weight:800; color:#444; margin-top:20px; font-size:14px; text-transform:uppercase;">Select Events:</p>
            <div id="dynamicEventGrid" class="event-grid">
                <div style="grid-column: span 2; text-align:center; color:#888;">Loading Events...</div>
            </div>

            <div id="extraDetailsArea" class="extra-details-container">
                <div class="extra-label">‚ÑπÔ∏è Additional Details Required:</div>
                <p id="extraDetailsPrompt" style="font-size:11px; margin:5px 0; color:#555;">For: Event Name</p>
                <textarea id="extraDetailsInput" rows="3" placeholder="Enter details (e.g. Blood Group, Aadhar). Max 100 words." oninput="checkWordCount(this)"></textarea>
                <div id="wordCountDisplay" style="font-size:10px; text-align:right; color:#666;">0/100 words</div>
            </div>

            <input type="text" id="otherEvent" placeholder="Event not listed? Request here..." style="border:2px dashed var(--primary); background:#fff5f5;">
            <button class="btn-submit" onclick="submitData('event')">REGISTER</button>
        </div>

        <div class="footer" ondblclick="unlockAdmin()">&copy; Developed By Flt Cdt Milan Singh</div>

        <div id="adminPanel" class="admin-panel">
            <h3 style="color:#ffcc00; margin-top:0; border-bottom:1px solid #555; padding-bottom:10px;">üëë Admin Zone</h3>
            
            <div class="admin-section">
                <label style="font-size:12px; color:#bbb;">üìÖ Set Date:</label>
                <div style="display:flex; gap:5px;">
                    <input type="date" id="adminDateInput" style="background:#444; color:white; border:none;">
                    <button class="btn-admin" style="background:#f57f17;" onclick="updateConfig('date')">Set</button>
                </div>
            </div>

            <div class="admin-section">
                <label style="font-size:12px; color:#bbb;">üî¥ Notice Board:</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newMarquee" placeholder="New text..." style="background:#444; color:white; border:none;">
                    <button class="btn-admin" onclick="updateConfig('marquee')">Update</button>
                </div>
            </div>

            <div class="admin-section">
                <label style="font-size:12px; color:#bbb;">üìÇ Reports:</label>
                <select id="pdfTarget" style="background:#444; color:white; border:none; margin-top:5px;">
                    <option value="Attendance">Attendance (Total Strength)</option>
                </select>
                <button class="btn-admin" style="width:100%; background:#0288d1;" <button onclick="getPDF()">SEE DETAILS üìã</button>
            </div>

            <div class="admin-section" style="border:none;">
                <label style="font-size:12px; color:#bbb;">‚öôÔ∏è Manage Events:</label>
                <div style="display:flex; gap:5px; align-items:center;">
                    <input type="text" id="newEventName" placeholder="New Event Name" style="background:#444; color:white; border:none;">
                </div>
                <div style="margin-top:5px;">
                    <label style="color:white; font-size:12px;">
                        <input type="checkbox" id="reqExtraCheck" style="width:auto;"> Requires Extra Info?
                    </label>
                </div>
                <button class="btn-admin" style="background:#2e7d32; width:100%; margin-top:5px;" onclick="manageEvent('add')">Add Event</button>
                
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="delEventName" placeholder="Remove Event Name" style="background:#444; color:white; border:none;">
                    <button class="btn-admin btn-danger" onclick="manageEvent('delete')">Del</button>
                </div>
            </div>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="success-icon">‚úÖ</span>
            <h3>Submitted!</h3>
            <p id="modalMsg">Recorded successfully.</p>
            <button class="btn-submit" onclick="document.getElementById('successModal').style.display='none'" style="margin-top:10px; width:100px; padding:10px;">OK</button>
        </div>
    </div>

    <datalist id="regList"></datalist><datalist id="nameList"></datalist>
    <datalist id="rankList"><option value="FLT CDT"><option value="CDT SGT"><option value="CWO"><option value="CUO"><option value="CSUO"></datalist>

<script>
    // ‚ö†Ô∏è PASTE YOUR SCRIPT URL HERE ‚ö†Ô∏è
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykmQU7d-T7EhjOTqn5QxBckDPxAkwb81vT6RNg1n__zZx2XTY5mMX__XWJsNi5qIs/exec";
    
    // --- DATABASE ---
    const regimentalNumbers = [];
    for(let i=1000; i<=1132; i++) regimentalNumbers.push(`DL2025SDAF128${i}`);
    const extraRegs = ["DL2024SDAF1280964", "DL2024SDAF1280642", "DL2024SDAF1280643", "DL2024SDAF1280644", "DL2024SDAF1280645", "DL2024SDAF1280646", "DL2024SDAF1280647", "DL2024SDAF1280648", "DL2024SDAF1280649", "DL2024SDAF1280650", "DL2024SDAF1280651", "DL2024SDAF1280960", "DL2024SDAF1280961", "DL2024SDAF1280962", "DL2024SDAF1280963", "DL2024SDAF1280965", "DL2024SDAF1280966", "DL2024SDAF1280967", "DL2024SDAF1280968", "DL2024SDAF1280969", "DL2024SDAF1280970", "DL2024SDAF1280971", "DL2024SDAF1280972", "DL2024SDAF1280973", "DL2024SDAF1280975", "DL2024SDAF1280979", "DL2024SDAF1280974", "DL2024SDAF1280590", "DL2024SDAF1280591", "DL2024SDAF1280592", "DL2024SDAF1280593", "DL2024SDAF1280594", "DL2024SDAF1280595", "DL2024SDAF1280596", "DL2024SDAF1280597", "DL2024SDAF1280598", "DL2024SDAF1280599", "DL2024SDAF1280600", "DL2024SDAF1280601", "DL2024SDAF1280602", "DL2024SDAF1280603", "DL2024SDAF1280604", "DL2024SDAF1280605", "DL2024SDAF1280606", "DL2024SDAF1280607", "DL2024SDAF1280608", "DL2024SDAF1280609", "DL2024SDAF1280610", "DL2024SDAF1280611", "DL2024SDAF1280612", "DL2024SDAF1280613", "DL2024SDAF1280615", "DL2024SDAF1280616", "DL2024SDAF1280617", "DL2024SDAF1280618", "DL2024SDAF1280619", "DL2024SDAF1280620", "DL2024SDAF1280621", "DL2024SDAF1280622", "DL2024SDAF1280623", "DL2024SDAF1280624", "DL2024SDAF1280625", "DL2024SDAF1280626", "DL2024SDAF1280627", "DL2024SDAF1280629", "DL2024SDAF1280631", "DL2024SDAF1280632", "DL2024SDAF1280633", "DL2024SDAF1280634", "DL2024SDAF1280635", "DL2024SDAF1280636", "DL2024SDAF1280637", "DL2024SDAF1280638", "DL2024SDAF1280639", "DL2024SDAF1280640", "DL2024SDAF1280641", "DL2024SDAF1280643", "DL2024SDAF1280942", "DL2024SDAF1280943", "DL2024SDAF1280944", "DL2024SDAF1280945", "DL2024SDAF1280946", "DL2024SDAF1280947", "DL2024SDAF1280948", "DL2024SDAF1280949", "DL2024SDAF1280950", "DL2024SDAF1280951", "DL2024SDAF1280952", "DL2024SDAF1280953", "DL2024SDAF1280954", "DL2024SDAF1280955", "DL2024SDAF1280956", "DL2024SDAF1280957", "DL2024SDAF1280958", "DL2024SDAF1280959","DL2025SDAF1280984", "DL2025SDAF1280985", "DL2025SDAF1280986", "DL2025SDAF1280987", "DL2025SDAF1280988", "DL2025SDAF1280989", "DL2025SDAF1280990", "DL2025SDAF1280991", "DL2025SDAF1280992", "DL2025SDAF1280993", "DL2025SDAF1280994", "DL2025SDAF1280995", "DL2025SDAF1280996", "DL2025SDAF1280997", "DL2025SDAF1280998", "DL2025SDAF1280999"];
    regimentalNumbers.push(...extraRegs);
    const names = ["Milan Singh", "PIYUSH PARMAR", "SAURABH YADAV", "Kartik Saini", "RISHABH RAJA", "Amrinder Singh Grewal", "Aniket Raj", "Kartikay Singh Jagirdar", "ANUJ YADAV", "Anubhav Kr Singh", "ABHINANDAN KUMAR SINGH", "SHUBHAM SHARMA", "RAHUL CHAURSIA", "ADITYA SIROHI", "Sameer chauhan", "Prem Bhardwaj", "Ravada Pawan Kumar", "Abhishek Mishra", "HARSHVARDHAN CHHETRI", "AALOK KUMAR", "Rahul Singh Dusad", "VISHU NAMDEV", "Madhusudan Singh Legha", "Hare Krishna Naik", "DHRUV CHAUHAN", "SHIVAM TIWARI", "PRIYANSHU THAKUR", "Samarth Rangar", "PRASHANT AWASTHI", "RISHABH NEGI", "Pratyush Bhalla", "TANISHK VERMA", "Nitin", "DEEPU", "Arpit", "Satyam Kumar", "SUJEET KUMAR YADAV", "PAWAN KUMAR SAH", "KARTIK DAGAR", "Aryan", "KANISH SHARMA", "HARSH RAJ SINGH", "Vivek Thakur", "RUDRAKSH SINGH", "Aditya Singh", "Vansh", "GOPAL", "Sankalp Choudhary", "Joysuriya Bhattacharjee", "ARYAN SINGH", "Anang Shashwat Tarun", "GARVIT", "ARPIT YADAV", "NAZIR UDDIN", "FAIZ MOHAMMAD", "ABDULLAH", "JITENDRA SINGH", "DILAWAR KHAN", "GULKESH", "IMRAN ALAM", "HASSAN HASAN", "AFTAB ALI", "MD MUSHFIQUE DANYAL", "MANABHANJAN MAHANANDA", "MUHAMMED YAZID A H", "SHAKEEB ARSALAN M P", "MOHAMMAD AHAMAD KHAN", "MD MASROOF ALAM", "GUFRAN KHAN", "NEERAJ", "SAHIL", "ATUL", "MANAS KUMAR JHA", "ANUJ SHAKYA", "VIKRAM SINGH", "SANDEEP", "SHREYASKOR BORGOHAIN", "VIKAS KUMAR GUPTA", "BIMAL GORAI", "PRASHANT KUMAR CHAUBEY", "SIDHARTH", "RAHUL SINGH", "HIMANSHU", "SHIV NARAYAN", "SANDEEP KUMAR", "ROHIT PANDEY", "SUBHAJIT DAS", "MD NASURALLAH", "SANDEEP YADAV", "SIMARJEET SINGH", "HIMANSHU SINGH TOMAR", "DEEPAK KUMAR", "HARSH YADAV", "PRATYUSH KUMAR SINGH", "GAUTAM RAWAT", "ADITYA SINGH", "KISHLEY ACHARYA", "TUSHAR YADAV", "VARUN KUMAR SINGH", "VANSH", "ADITYA JHA", "SHIVANG SHARMA", "GENIUS CHAUHAN", "VISHAL GUPTA", "ANSHUL DIXIT", "SATYAM KUMAR", "YASH RAJ", "RAJ KUMAR", "ABHIMANYU KELODIYA", "SUKEERAT SINGH", "HARMANDEEP SINGH", "ABHISHEK MANDAL", "NIKHIL KUMAR", "NACHIKETA SANASAM", "ABHINIT KUMAR", "DHRUV UPRETI", "KARTIK ROSE", "ANSH JOON", "MOHIT KUMAR SINGH", "ARYAN GAMBHIR", "SHRESTHA BHANDARI", "SAKSHAM DUBEY", "NAKUL", "SHIVANG YADAV", "KONADA MOHAN SRIVATSAV", "SUBHAM SINGH", "ANGAT BAKHLA", "DURGA SHANKER PANDEY", "HITENDRA PRATAP SINGH", "HIMANSHU YADAV", "ARYAN SHRIVASTAVA", "HIRA LAUR", "VANSH DABAS", "DAKSH BHATI", "HIMANSHU", "NEERAJ YADAV", "HARSHVARDHAN", "PARTH SINGH", "PRADEEP KUMAR", "PRAVESH KUMAR", "ANUJ RAWAT", "VISHAV VARDHAN SINGH RATHORE", "PRIYANSHU RAJ", "YASH RATHEE", "ANKIT KUMAR", "ANUBHAV", "RISHABH RANA", "RONAK SINGH", "KAPISH", "KUMAR ARYAN", "PRANAV BHATT", "UTTAM", "VATSAL VASHISHTH", "HARI OM", "MEHARSH BENSLA", "ARTHAV UPADHYAY", "JAI PRATAP SINGH", "ADITYA KUMAR YADAV", "SAURAV KUMAR", "RITIK", "ARYAN PRASAD", "SHUBHAM SIHAG", "MANISH KUMAR", "SHUBHAM KUMAR SAURABH", "DEV KUMAR GOPALA", "SACHIN KUMAR JHA", "YASH KUMAR RAI", "PIYUSH KUMAR", "YATHARTH SINGH BANSLA", "SHASHWAT KUMAR MISHRA", "RANJEET KUMAR", "TUSHAR DAGAR", "PRASHANT KUMAR", "HIMANSHU KUMAR", "AYUSH YADAV", "AYUSH RANJAN", "RAJVEER YADAV", "AAMIR JAVID", "SHRI KISHAN", "DANISH IQBAL", "KESHAV KUMAR JHA", "CHINMAY DIXIT", "MARUPH PARVEZ", "YASH NAGAL", "SURAJ", "ABU SHAMA NOOR", "ROHIT", "DIVYANSH SINGH", "MOHAMMAD SHAHRUKH KHAN", "ANAND", "WASIM AKRAM", "MOHAMMAD ALI", "NISHANT SINGH", "AZIM JAVED", "ZAYAAN KHURSHEED", "SALIM", "MOHD AFFAN", "ADHNAN V"];

    const regDL = document.getElementById('regList'); regimentalNumbers.forEach(v => { let o = document.createElement('option'); o.value = v; regDL.appendChild(o); });
    const nameDL = document.getElementById('nameList'); names.forEach(v => { let o = document.createElement('option'); o.value = v; nameDL.appendChild(o); });

    function switchTab(t) {
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(e => e.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelector(`button[onclick="switchTab('${t}')"]`).classList.add('active');
    }

    // --- EVENTS & UI LOGIC ---
    window.onload = function() {
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'get_init_data' }) })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                document.getElementById('marqueeText').innerText = data.marquee || "Welcome to VAYUSETU";
                document.getElementById('displayDate').value = data.sysDate || "Loading...";
                
                const list = document.getElementById('dynamicEventGrid');
                const pdfSel = document.getElementById('pdfTarget');
                list.innerHTML = "";
                while(pdfSel.options.length > 1) { pdfSel.remove(1); } 

                data.events.forEach(evt => {
                    // SAFE HANDLING: Works with both "Strings" and "Objects"
                    let eventName = "";
                    let isExtra = false;
                    
                    if (typeof evt === 'object' && evt !== null) {
                        eventName = evt.name;
                        isExtra = evt.reqExtra;
                    } else {
                        eventName = String(evt);
                    }

                    let card = document.createElement('div');
                    card.className = 'event-card';
                    card.innerText = eventName;
                    card.dataset.name = eventName;
                    card.dataset.reqExtra = isExtra;
                    
                    card.onclick = function() { 
                        this.classList.toggle('selected');
                        checkExtraDetails(); 
                    };
                    list.appendChild(card);

                    let opt = document.createElement('option');
                    opt.value = eventName; opt.innerText = eventName;
                    pdfSel.appendChild(opt);
                });
            }
        })
        .catch(e => {
            document.getElementById('marqueeText').innerText = "System Offline - Check Connection";
            document.getElementById('displayDate').value = "Offline";
        });
    };

    function checkExtraDetails() {
        const selectedCards = document.querySelectorAll('.event-card.selected');
        const extraDiv = document.getElementById('extraDetailsArea');
        const promptText = document.getElementById('extraDetailsPrompt');
        
        let needingExtra = [];
        selectedCards.forEach(c => {
            // Check strings "true" or boolean true
            if (c.dataset.reqExtra === "true" || c.dataset.reqExtra === true) needingExtra.push(c.dataset.name);
        });

        if (needingExtra.length > 0) {
            extraDiv.style.display = 'block';
            promptText.innerText = "For: " + needingExtra.join(", ");
        } else {
            extraDiv.style.display = 'none';
            document.getElementById('extraDetailsInput').value = "";
        }
    }

    function checkWordCount(field) {
        let words = field.value.trim().split(/\s+/).length;
        if(field.value.trim() === "") words = 0;
        document.getElementById('wordCountDisplay').innerText = words + "/100 words";
        if (words > 100) field.style.borderColor = "red";
        else field.style.borderColor = "#e0e0e0";
    }

    function submitData(type) {
        let payload = {};
        if(type === 'attendance') {
            payload.action = 'submit_attendance';
            payload.regimentalNo = document.getElementById('regAtt').value;
            payload.rank = document.getElementById('rankAtt').value;
            payload.name = document.getElementById('nameAtt').value;
            payload.year = document.getElementById('yearAtt').value;
            payload.squadron = document.getElementById('squadAtt').value;
            payload.attDate = document.getElementById('displayDate').value;
            if(!payload.regimentalNo || !payload.name) return alert("Fill all details");
        } else {
            payload.action = 'submit_event';
            payload.regimentalNo = document.getElementById('regEvt').value;
            payload.rank = document.getElementById('rankEvt').value;
            payload.name = document.getElementById('nameEvt').value;
            payload.year = document.getElementById('yearEvt').value;
            payload.squadron = document.getElementById('squadEvt').value;
            
            const selectedCards = document.querySelectorAll('.event-card.selected');
            const eventsData = [];
            
            selectedCards.forEach(c => {
                let evtObj = { name: c.dataset.name, extra: "" };
                // Check if this specific card requires extra info
                if (c.dataset.reqExtra === "true" || c.dataset.reqExtra === true) {
                    evtObj.extra = document.getElementById('extraDetailsInput').value;
                }
                eventsData.push(evtObj);
            });

            payload.events = eventsData;
            payload.otherEvent = document.getElementById('otherEvent').value;
            
            if(payload.events.length === 0 && !payload.otherEvent) return alert("Select an event or type a request");
            if(document.getElementById('extraDetailsInput').value.split(/\s+/).length > 100) return alert("Extra details must be under 100 words.");
            if(!payload.regimentalNo) return alert("Fill personal details");
        }

        const btn = event.target;
        btn.innerText = "Transmitting...";
        
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                document.getElementById('modalMsg').innerText = data.message;
                document.getElementById('successModal').style.display = 'flex';
                if(type === 'event') {
                    document.querySelectorAll('.event-card').forEach(c => c.classList.remove('selected'));
                    document.getElementById('otherEvent').value = "";
                    document.getElementById('extraDetailsInput').value = "";
                    document.getElementById('extraDetailsArea').style.display = 'none';
                }
            } else {
                alert("Error: " + data.message);
            }
            btn.innerText = (type === 'attendance') ? "MARK PRESENT" : "REGISTER";
        });
    }

    function unlockAdmin() { if(prompt("Admin PIN:") === "2347") { document.getElementById('adminPanel').style.display = 'block'; window.scrollTo(0, document.body.scrollHeight); } }
    function updateConfig(type) {
        let val = (type === 'marquee') ? document.getElementById('newMarquee').value : document.getElementById('adminDateInput').value;
        if(!val) return;
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', type: type, value: val, pin: "2347" }) }).then(r => r.json()).then(d => { alert(d.message); if(type === 'date') document.getElementById('displayDate').value = val; if(type === 'marquee') document.getElementById('marqueeText').innerText = val; });
    }
    function manageEvent(type) {
        const name = (type === 'add') ? document.getElementById('newEventName').value : document.getElementById('delEventName').value;
        const reqExtra = document.getElementById('reqExtraCheck').checked;
        if(!name) return;
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'manage_event', type: type, eventName: name, reqExtra: reqExtra, pin: "2347" }) }).then(r => r.json()).then(d => { alert(d.message); location.reload(); });
    }
    function getPDF() {
        const target = document.getElementById('pdfTarget').value;
        const btn = document.querySelector('button[onclick="getPDF()"]');
        const originalText = btn.innerText;
        
        // 1. Show Loading State
        btn.innerText = "Generating...";
        btn.disabled = true;

        fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'get_pdf', target: target, pin: "2347" }) 
        })
        .then(r => r.json())
        .then(d => { 
            // 2. Reset Button
            btn.innerText = originalText;
            btn.disabled = false;

            if(d.status === 'success') {
                // --- MOBILE DOWNLOAD FIX ---
                // Instead of window.open, we create a hidden link and click it.
                // This tells mobile browsers "Download this file" instead of "Open this app".
                let a = document.createElement('a');
                a.href = d.url;
                a.download = target + "_Report.pdf"; // Suggests a filename
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert(d.message); 
            }
        })
        .catch(error => {
            btn.innerText = originalText;
            btn.disabled = false;
            alert("Network Error. Please try again.");
        });
    }
</script>
</body>
</html>





